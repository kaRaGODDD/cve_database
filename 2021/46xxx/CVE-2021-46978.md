
# [CVE-2021-46978](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-46978)

## Description

- `In the Linux kernel, the following vulnerability has been resolved:KVM: nVMX: Always make an attempt to map eVMCS after migrationWhen enlightened VMCS is in use and nested state is migrated withvmx_get_nested_state()/vmx_set_nested_state() KVM can't map evmcspage right away: evmcs gpa is not 'struct kvm_vmx_nested_state_hdr'and we can't read it from VP assist page because userspace may decideto restore HV_X64_MSR_VP_ASSIST_PAGE after restoring nested state(and QEMU, for example, does exactly that). To make sure eVMCS ismapped /vmx_set_nested_state() raises KVM_REQ_GET_NESTED_STATE_PAGESrequest.Commit f2c7ef3ba955 ("KVM: nSVM: cancel KVM_REQ_GET_NESTED_STATE_PAGESon nested vmexit") added KVM_REQ_GET_NESTED_STATE_PAGES clearing tonested_vmx_vmexit() to make sure MSR permission bitmap is not switchedwhen an immediate exit from L2 to L1 happens right after migration (causedby a pending event, for example). Unfortunately, in the exact samesituation we still need to have eVMCS mapped sonested_sync_vmcs12_to_shadow() reflects changes in VMCS12 to eVMCS.As a band-aid, restore nested_get_evmcs_page() when clearingKVM_REQ_GET_NESTED_STATE_PAGES in nested_vmx_vmexit(). The 'fix' is farfrom being ideal as we can't easily propagate possible failures and even ifwe could, this is most likely already too late to do so. The whole'KVM_REQ_GET_NESTED_STATE_PAGES' idea for mapping eVMCS after migrationseems to be fragile as we diverge too much from the 'native' path whenvmptr loading happens on vmx_set_nested_state().`

## Cvss Data

- **Access Vector**:
  - 
- **Base Score**:
  - 

## Scores

- **Exploitability Score**:
  - 
- **Impact Score**:
  - 
- **Base Severity**:
  - 

## Other Information

- **Publish Date**:
  - 2024-02-28 09:15:37
- **Vulnerability Status**:
  - Awaiting Analysis

## References

- **416baaa9-dc9f-4396-8d5f-8c081fb06d67**: https://git.kernel.org/stable/c/200a45649ab7361bc80c70aebf7165b64f9a6c9f
- **416baaa9-dc9f-4396-8d5f-8c081fb06d67**: https://git.kernel.org/stable/c/bd0e8455b85b651a4c77de9616e307129b15aaa7
- **416baaa9-dc9f-4396-8d5f-8c081fb06d67**: https://git.kernel.org/stable/c/c8bf64e3fb77cc19bad146fbe26651985b117194
- **416baaa9-dc9f-4396-8d5f-8c081fb06d67**: https://git.kernel.org/stable/c/f5c7e8425f18fdb9bdb7d13340651d7876890329

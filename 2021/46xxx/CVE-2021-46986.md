
# [CVE-2021-46986](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-46986)

## Description

- `In the Linux kernel, the following vulnerability has been resolved:usb: dwc3: gadget: Free gadget structure only after freeing endpointsAs part of commit e81a7018d93a ("usb: dwc3: allocate gadget structuredynamically") the dwc3_gadget_release() was added which will freethe dwc->gadget structure upon the device's removal whenusb_del_gadget_udc() is called in dwc3_gadget_exit().However, simply freeing the gadget results a dangling pointersituation: the endpoints created in dwc3_gadget_init_endpoints()have their dep->endpoint.ep_list members chained off the list_headanchored at dwc->gadget->ep_list.  Thus when dwc->gadget is freed,the first dwc3_ep in the list now has a dangling prev pointer andlikewise for the next pointer of the dwc3_ep at the tail of the list.The dwc3_gadget_free_endpoints() that follows will result in ause-after-free when it calls list_del().This was caught by enabling KASAN and performing a driver unbind.The recent commit 568262bf5492 ("usb: dwc3: core: Add shutdowncallback for dwc3") also exposes this as a panic during shutdown.There are a few possibilities to fix this.  One could be to performa list_del() of the gadget->ep_list itself which removes it fromthe rest of the dwc3_ep chain.Another approach is what this patch does, by splitting up theusb_del_gadget_udc() call into its separate "del" and "put"components.  This allows dwc3_gadget_free_endpoints() to becalled before the gadget is finally freed with usb_put_gadget().`

## Cvss Data

- **Access Vector**:
  - 
- **Base Score**:
  - 

## Scores

- **Exploitability Score**:
  - 
- **Impact Score**:
  - 
- **Base Severity**:
  - 

## Other Information

- **Publish Date**:
  - 2024-02-28 09:15:37
- **Vulnerability Status**:
  - Awaiting Analysis

## References

- **416baaa9-dc9f-4396-8d5f-8c081fb06d67**: https://git.kernel.org/stable/c/1ea775021282d90e1d08d696b7ab54aa75d688e5
- **416baaa9-dc9f-4396-8d5f-8c081fb06d67**: https://git.kernel.org/stable/c/b4b8e9601d7ee8806d2687f081a42485d27674a1
- **416baaa9-dc9f-4396-8d5f-8c081fb06d67**: https://git.kernel.org/stable/c/bb9c74a5bd1462499fe5ccb1e3c5ac40dcfa9139
- **416baaa9-dc9f-4396-8d5f-8c081fb06d67**: https://git.kernel.org/stable/c/bc0cdd72493236fb72b390ad38ce581e353c143c
